# ============================================================================
# CORE SETTINGS
# ============================================================================

setw -g mode-keys vi
set -g escape-time 0              # Faster escape for nvim responsiveness
set -g default-terminal "xterm-256color"
set -g history-limit 10000
set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g allow-passthrough on
set -g set-clipboard on               # OSC52 clipboard sync (works over SSH)

# ============================================================================
# PREFIX CONFIGURATION
# ============================================================================

unbind C-b
set -g prefix C-a
bind C-a send-prefix -2

# ============================================================================
# STATUS BAR - NO COLORS, match sketchybar spacing
# ============================================================================

set -g status on
set -g status-position top
set -g status-style "none"
set -g status-bg default
set -g status-fg default
set -g status-justify centre

# Session display - minimal prefix indicator (space placeholder to prevent reflow)
set -g status-left-length 10
set -g status-left "#{?client_prefix,#[fg=#ff279a]  ✦  #[default],     }"

# Window status - minimal with nerdfont, extra spacing
setw -g window-status-format "  #I #W#{?#{==:#{window_panes},1},,#{?#{==:#{window_panes},2},⚌,#{?#{==:#{window_panes},3},☰,#{?#{==:#{window_panes},4},⚍,#{?#{==:#{window_panes},5},⚏,☷}}}}}  "
setw -g window-status-current-format "  #W  "
setw -g window-status-separator ""
setw -g window-status-style "default"
setw -g window-status-current-style "reverse"

# Right status - Mutagen (only when syncing/error) + Tailscale (only when connected)
set -g status-right-length 30
set -g status-right "#(~/.dotfiles/bin/tmux-mutagen-status 2>/dev/null)#(tailscale status >/dev/null 2>&1 && echo '󰖂 ' || echo '')"

# Remove all colors
set -g message-style "none"
set -g message-command-style "none"
set -g window-status-activity-style "none"
set -g window-status-bell-style "none"

# ============================================================================
# PANE STYLING
# ============================================================================

# Arrow indicators pointing to active pane - vulpes red accent
set -g pane-border-indicators arrows
set -g pane-border-style "fg=#73264a"
set -g pane-active-border-style "fg=#ff0055"

# Subtle underline for active pane only
# set -g pane-border-status bottom
# set -g pane-border-format ""
# set -g pane-active-border-format "─"

# ============================================================================
# PANE NAVIGATION & MANAGEMENT
# ============================================================================

# Vim-style pane navigation
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# Pane swapping
bind > swap-pane -D
bind < swap-pane -U

# Resize with capital letters
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Alt + number to switch panes directly
bind -n M-1 select-pane -t 1
bind -n M-2 select-pane -t 2
bind -n M-3 select-pane -t 3
bind -n M-4 select-pane -t 4
bind -n M-5 select-pane -t 5
bind -n M-6 select-pane -t 6
bind -n M-7 select-pane -t 7
bind -n M-8 select-pane -t 8
bind -n M-9 select-pane -t 9

# Window splitting with current path
bind - split-window -v -c "#{pane_current_path}"
bind _ split-window -h -c "#{pane_current_path}"

# ============================================================================
# WINDOW NAVIGATION & MANAGEMENT
# ============================================================================

# Create new windows with current path
bind c new-window -c "#{pane_current_path}"

# Alt+h/l for prev/next window
bind -n M-h previous-window
bind -n M-l next-window

# Shift+arrows for window navigation
bind -n S-Left previous-window
bind -n S-Right next-window

# ============================================================================
# SESSION MANAGEMENT
# ============================================================================

bind C-c new-session
bind C-f command-prompt -p "Find session:" "switch-client -t '%%'"

# Zen mode toggle
bind Z run-shell "~/.zen-mode.sh"

# ============================================================================
# UTILITY BINDINGS
# ============================================================================

# Tree mode tweaks
bind w choose-tree -w
set -g mode-style 'fg=default,bg=default,reverse'

# Popup bindings - Modern floating window workflows
bind-key "g" display-popup -d '#{pane_current_path}' -E -w 85% -h 85% "lazygit"         # Popup lazygit
bind-key "K" display-popup -d '#{pane_current_path}' -E -w 85% -h 85% "yazi"            # Popup file manager
bind-key "?" display-popup -E -w 60% -h 60% "cat ~/tips.txt | fzf --reverse"            # Tips cheatsheet
bind-key "S" run-shell "~/.local/bin/tmux-scratch-toggle"                              # Scratch terminal (toggleable + persistent)

# Capture pane to clipboard
bind-key C-y run-shell "tmux capture-pane -pS- | pbcopy"    # Capture entire pane (all scrollback)
bind-key M-y run-shell "tmux capture-pane -pS-200 | pbcopy" # Capture last 200 lines

# Open scrollback in nvim (for searching/copying with vim motions)
bind-key e run "tmux capture-pane -S 0 -p -J > /tmp/tmux-scrollback && tmux new-window 'nvim /tmp/tmux-scrollback'"
bind-key E run "tmux capture-pane -S - -p -J > /tmp/tmux-scrollback && tmux new-window 'nvim /tmp/tmux-scrollback'"

# NO-PREFIX instant capture (root table - works anywhere)
bind-key -n M-c run-shell "tmux capture-pane -pS- | pbcopy && tmux display-message 'pane → clipboard'"
bind-key -n M-C run-shell "tmux capture-pane -pS- -t! | pbcopy && tmux display-message 'last pane → clipboard'"
bind-key -n M-v run-shell "tmux capture-pane -p | pbcopy && tmux display-message 'visible → clipboard'"

# Send pane content to another pane (for piping to Claude Code, etc)
bind-key P run-shell "tmux capture-pane -p | tmux load-buffer - && tmux display-message 'ready to paste (prefix+])'"

# Quick note capture to Obsidian inbox
bind-key N command-prompt -p "Quick note:" "run-shell \"echo '- %% (captured #{t:window_name})' >> ~/Library/Mobile\\ Documents/iCloud~md~obsidian/Documents/ejfox/inbox.md && tmux display-message 'noted'\""

# SSH reconnection helpers
bind-key R respawn-pane -k                                  # Kill + respawn pane with same command (instant reconnect)

# ============================================================================
# PLUGINS
# ============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'christoomey/vim-tmux-navigator'  # Seamless vim/tmux navigation
# set -g @plugin 'fcsonline/tmux-thumbs'           # Disabled - wasn't useful
set -g @plugin 'jaclu/tmux-menus'                # Visual TUI menu for all tmux functions (Ctrl-\)

# Disabled plugins
# set -g @plugin 'Morantron/tmux-fingers'  # Replaced with tmux-thumbs (Rust version)
# set -g @plugin 'arl/tmux-gitbar'
# set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
# set -g @plugin 'tmux-plugins/tmux-git'

# ============================================================================
# PLUGIN CONFIGURATION
# ============================================================================

# tmux-fzf
set -g @tmux-fzf-launch 'F'

# tmux-continuum
set -g @continuum-restore 'on'

# tmux-resurrect - Process restoration based on actual usage patterns
set -g @resurrect-save-command-strategy 'cmdline'
set -g @resurrect-processes 'vi vim nvim \
  man less more tail \
  neomutt \
  yazi lazygit \
  node \
  psql \
  codex \
  toot \
  "~claude --dangerously-skip-permissions" \
  "~npm run dev" "~npm run dev:production" "~npm run e" \
  "~pnpm dev" "~yarn dev"'

# Copy mode - extra binding for convenience
bind Space copy-mode

# tmux-thumbs - Disabled
# set -g @thumbs-key 'Space'
# set -g @thumbs-alphabet 'asdfghjkl'
# set -g @thumbs-command 'echo -n {} | pbcopy'
# set -g @thumbs-upcase-command 'echo -n {} | pbcopy && tmux paste-buffer'


# ============================================================================
# THEME & LOCAL OVERRIDES
# ============================================================================

# Initialize TMUX plugin manager
run '~/.tmux/plugins/tpm/tpm'

# Copy mode vi bindings - MUST be after plugin init to override tmux-yank
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel
bind-key -T copy-mode-vi 'C-v' send -X rectangle-toggle
bind-key -T copy-mode-vi Escape send -X cancel

# vulpes-reddish2 theme
source-file ~/.dotfiles/vulpes-reddish2-dark-tmux.tmux.conf
# source-file ~/.dotfiles/vulpes-reddish2-light-tmux.tmux.conf

# Load local config AFTER everything else
if-shell "[ -f ~/.tmux.conf.local ]" 'source ~/.tmux.conf.local'

# tmux-link-grab config (before plugin init)
set -g @link-grab-key "s"
set -g @link-grab-scope "window"
set -g @link-grab-action "open"
run-shell ~/.dotfiles/tmux-plugins/tmux-link-grab/plugin.tmux
