#!/bin/bash
# =============================================================================
# DOTFILES VERIFICATION / HEALTH CHECK
# =============================================================================
# Checks that all dotfiles are properly symlinked, dependencies installed,
# and configuration is working. Run after sync-dotfiles.sh or on any new machine.
#
# Usage: dotfiles-verify [--fix]
#   --fix  Attempt to fix issues by running sync-dotfiles.sh
# =============================================================================

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

# Detect Homebrew prefix
if [[ -d "/opt/homebrew" ]]; then
  BREW_PREFIX="/opt/homebrew"
  ARCH="Apple Silicon"
else
  BREW_PREFIX="/usr/local"
  ARCH="Intel"
fi

PASS=0
WARN=0
FAIL=0
FIX_MODE=false

[[ "$1" == "--fix" ]] && FIX_MODE=true

pass() { echo -e "  ${GREEN}OK${NC}  $1"; PASS=$((PASS + 1)); }
warn() { echo -e "  ${YELLOW}!!${NC}  $1"; WARN=$((WARN + 1)); }
fail() { echo -e "  ${RED}XX${NC}  $1"; FAIL=$((FAIL + 1)); }

echo ""
echo -e "${CYAN}DOTFILES HEALTH CHECK${NC}  ${DIM}($ARCH, brew: $BREW_PREFIX)${NC}"
echo "================================================================"

# -------------------------------------------------------------------------
# 1. SYMLINKS - Core dotfiles
# -------------------------------------------------------------------------
echo ""
echo -e "${CYAN}[1/6] Core dotfile symlinks${NC}"

CORE_FILES=(
  ".zshrc"
  ".tmux.conf"
  ".startup.sh"
  ".p10k.zsh"
  ".gitconfig"
  ".zprofile"
  ".bash_profile"
  ".zen-mode.sh"
  ".zshenv"
  ".llm-persona.txt"
)

for f in "${CORE_FILES[@]}"; do
  if [ -L "$HOME/$f" ]; then
    target=$(readlink "$HOME/$f")
    if [[ "$target" == *".dotfiles/$f"* ]]; then
      pass "$f"
    else
      warn "$f symlink points to unexpected target: $target"
    fi
  elif [ -f "$HOME/$f" ]; then
    fail "$f exists but is NOT a symlink (not tracked)"
  else
    fail "$f missing"
  fi
done

# -------------------------------------------------------------------------
# 2. SYMLINKS - Config directories
# -------------------------------------------------------------------------
echo ""
echo -e "${CYAN}[2/6] Config directory symlinks${NC}"

CONFIG_DIRS=(
  "nvim"
  "ghostty"
  "yazi"
  "btop"
  "atuin"
  "bat"
  "htop"
  "karabiner"
  "lazygit"
  "neofetch"
  "neomutt"
  "sketchybar"
  "wireshark"
  "zsh"
)

for d in "${CONFIG_DIRS[@]}"; do
  if [ -L "$HOME/.config/$d" ]; then
    target=$(readlink "$HOME/.config/$d")
    if [[ "$target" == *".dotfiles/.config/$d"* ]]; then
      pass ".config/$d"
    else
      warn ".config/$d symlink points to: $target"
    fi
  elif [ -d "$HOME/.config/$d" ]; then
    fail ".config/$d exists but is NOT a symlink (untracked copy)"
  else
    fail ".config/$d missing"
  fi
done

# -------------------------------------------------------------------------
# 3. PATH & bin scripts
# -------------------------------------------------------------------------
echo ""
echo -e "${CYAN}[3/6] PATH and bin scripts${NC}"

if echo "$PATH" | tr ':' '\n' | grep -q "\.dotfiles/bin"; then
  pass "~/.dotfiles/bin in PATH"
else
  fail "~/.dotfiles/bin NOT in PATH"
fi

for script in ai-commit morning-ritual dotfiles-audit dotfiles-verify usage-log usage-summary usage-analyze; do
  if [ -x "$HOME/.dotfiles/bin/$script" ]; then
    pass "bin/$script (executable)"
  elif [ -f "$HOME/.dotfiles/bin/$script" ]; then
    warn "bin/$script exists but not executable"
  else
    warn "bin/$script missing"
  fi
done

# -------------------------------------------------------------------------
# 4. Dependencies
# -------------------------------------------------------------------------
echo ""
echo -e "${CYAN}[4/6] Key dependencies${NC}"

# Critical (shell won't work right without these)
CRITICAL_DEPS=(nvim tmux fzf rg zoxide lsd bat git gh)
for dep in "${CRITICAL_DEPS[@]}"; do
  if command -v "$dep" &>/dev/null; then
    pass "$dep"
  else
    fail "$dep not installed"
  fi
done

# Optional (nice to have)
OPTIONAL_DEPS=(mosh lazygit yazi jq atuin bun node)
for dep in "${OPTIONAL_DEPS[@]}"; do
  if command -v "$dep" &>/dev/null; then
    pass "$dep"
  else
    warn "$dep not installed ${DIM}(optional)${NC}"
  fi
done

# -------------------------------------------------------------------------
# 5. Shell configuration
# -------------------------------------------------------------------------
echo ""
echo -e "${CYAN}[5/6] Shell configuration${NC}"

# Oh My Zsh
if [ -d "$HOME/.oh-my-zsh" ]; then
  pass "Oh My Zsh installed"
else
  fail "Oh My Zsh missing"
fi

# OMZ plugins
for plugin in zsh-autosuggestions; do
  if [ -d "$HOME/.oh-my-zsh/custom/plugins/$plugin" ]; then
    pass "OMZ plugin: $plugin"
  else
    fail "OMZ plugin missing: $plugin"
  fi
done

# Powerlevel10k
if [ -d "$HOME/.oh-my-zsh/custom/themes/powerlevel10k" ]; then
  pass "Powerlevel10k theme"
else
  fail "Powerlevel10k theme missing"
fi

# Vulpes theme files
if [ -f "$HOME/.config/zsh/themes/vulpes-reddishnovember-dark.zsh" ]; then
  pass "Vulpes dark theme"
else
  fail "Vulpes dark theme missing (~/.config/zsh not symlinked?)"
fi
if [ -f "$HOME/.config/zsh/themes/vulpes-reddishnovember-light.zsh" ]; then
  pass "Vulpes light theme"
else
  fail "Vulpes light theme missing"
fi

# .env file
if [ -f "$HOME/.env" ]; then
  pass "~/.env exists (secrets file)"
else
  warn "~/.env missing (some features need API keys)"
fi

# NVM
if [ -s "$BREW_PREFIX/opt/nvm/nvm.sh" ] || [ -s "$HOME/.nvm/nvm.sh" ]; then
  pass "NVM installed"
else
  warn "NVM not found"
fi

# -------------------------------------------------------------------------
# 6. Git & security
# -------------------------------------------------------------------------
echo ""
echo -e "${CYAN}[6/6] Git and security${NC}"

cd ~/.dotfiles

# Pre-commit hook
HOOKS_PATH=$(git config core.hooksPath 2>/dev/null || echo "")
if [ "$HOOKS_PATH" = ".githooks" ] && [ -x ".githooks/pre-commit" ]; then
  pass "Pre-commit security hook active"
elif [ -n "$HOOKS_PATH" ]; then
  warn "core.hooksPath=$HOOKS_PATH but hook may not be executable"
else
  fail "Pre-commit hook not configured (run: git config core.hooksPath .githooks)"
fi

# Check for uncommitted changes
if git diff --quiet 2>/dev/null; then
  pass "No uncommitted changes"
else
  CHANGED=$(git diff --name-only | wc -l | tr -d ' ')
  warn "$CHANGED file(s) with uncommitted changes"
fi

# Check remote is up to date
LOCAL=$(git rev-parse HEAD 2>/dev/null)
REMOTE=$(git rev-parse origin/main 2>/dev/null)
if [ "$LOCAL" = "$REMOTE" ]; then
  pass "Up to date with origin/main"
else
  warn "Local differs from origin/main"
fi

# -------------------------------------------------------------------------
# Summary
# -------------------------------------------------------------------------
echo ""
echo "================================================================"
TOTAL=$((PASS + WARN + FAIL))
echo -e "  ${GREEN}$PASS passed${NC}  ${YELLOW}$WARN warnings${NC}  ${RED}$FAIL failed${NC}  ($TOTAL checks)"

if [ $FAIL -gt 0 ]; then
  echo ""
  if $FIX_MODE; then
    echo "Attempting fixes..."
    bash ~/.dotfiles/sync-dotfiles.sh
    echo ""
    echo "Re-run 'dotfiles-verify' to check results."
  else
    echo -e "  Run ${CYAN}dotfiles-verify --fix${NC} to attempt automatic fixes"
    echo -e "  Or run ${CYAN}sync-dotfiles.sh${NC} manually"
  fi
  exit 1
elif [ $WARN -gt 0 ]; then
  echo ""
  echo "  Warnings are non-critical but worth reviewing."
  exit 0
else
  echo ""
  echo "  Everything looks good."
  exit 0
fi
