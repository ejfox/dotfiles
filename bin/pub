#!/bin/bash
# pub - Publishing workflow bridge (Obsidian â†’ website2)
# Simplifies the content creation + publishing pipeline

set -e

OBS_VAULT="/Users/ejfox/Library/Mobile Documents/iCloud~md~obsidian/Documents/ejfox"
WEB_DIR="$HOME/code/website2"
WEB_CONTENT="$WEB_DIR/content"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

usage() {
  cat << EOF
${BLUE}pub${NC} - Publishing workflow (Obsidian â†’ website2)

${YELLOW}USAGE${NC}
  pub <command> [options]

${YELLOW}COMMANDS${NC}
  status                    Show publishing status
  import                    Run import pipeline (Obsidian â†’ website2)
  watch                     Watch vault for changes and auto-import
  publish                   Full publish workflow (import â†’ build â†’ push)
  preview <type>            Preview posts of type (blog, robot, weeknote, etc)
  info <file>               Show metadata for a file
  open <file>               Open file in Obsidian

${YELLOW}OPTIONS${NC}
  -d, --dry-run            Show what would happen (import only)
  -f, --force              Skip safety checks
  -q, --quiet              Minimal output

${YELLOW}EXAMPLES${NC}
  pub import               Import all whitelisted content
  pub publish              Full publish workflow
  pub watch                Auto-import on vault changes
  pub preview blog         See recent blog posts
  pub status               Check what's pending

EOF
}

log() {
  if [ "$QUIET" != "1" ]; then
    echo -e "${BLUE}[pub]${NC} $*"
  fi
}

success() {
  echo -e "${GREEN}âœ“${NC} $*"
}

error() {
  echo -e "${RED}âœ—${NC} $*" >&2
}

warn() {
  echo -e "${YELLOW}âš ${NC} $*"
}

cmd_status() {
  log "Checking publishing status..."

  cd "$WEB_DIR"

  # Check git status
  local changes=$(git status --porcelain | wc -l)
  local commits_ahead=$(git rev-list @{u}..HEAD 2>/dev/null | wc -l)

  if [ "$changes" -gt 0 ]; then
    warn "Uncommitted changes: $changes files"
    git status --short | head -5
  else
    success "Working tree clean"
  fi

  if [ "$commits_ahead" -gt 0 ]; then
    warn "Commits ahead of origin: $commits_ahead"
  fi

  # Check recent posts
  log "Recent content in website2:"
  find "$WEB_CONTENT/blog" -name "*.md" -type f | sort -r | head -5 | while read f; do
    local name=$(basename "$f" .md)
    local mtime=$(stat -f%Sm -t%Y-%m-%d "$f")
    echo "  $mtime  $name"
  done
}

cmd_import() {
  log "Running import pipeline..."

  cd "$WEB_DIR"

  if [ "$DRY_RUN" = "1" ]; then
    log "(dry run mode - no files will be modified)"
    node scripts/blog/import.mjs --dry-run 2>&1 | head -20
  else
    if ! node scripts/blog/import.mjs; then
      error "Import failed"
      exit 1
    fi
    success "Import completed"
    cmd_status
  fi
}

cmd_watch() {
  log "Starting file watcher..."
  log "Watching: $OBS_VAULT"
  warn "Press Ctrl+C to stop"

  cd "$WEB_DIR"
  bash scripts/blog/watch.sh
}

cmd_publish() {
  if [ "$FORCE" != "1" ]; then
    log "Running full publish workflow"
    log "This will:"
    echo "  1. Import content from Obsidian"
    echo "  2. Build the site"
    echo "  3. Commit and push changes"
    echo ""
    read -p "Continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      log "Cancelled"
      exit 0
    fi
  fi

  cd "$WEB_DIR"

  log "Starting publish workflow..."
  if bash scripts/blog/publish.sh; then
    success "Publish completed successfully"
  else
    error "Publish failed - check logs"
    exit 1
  fi
}

cmd_preview() {
  local type="${1:-blog}"
  log "Preview: $type posts"

  case "$type" in
    blog)
      find "$WEB_CONTENT/blog" -name "*.md" -type f | sort -r | head -10 | while read f; do
        local name=$(basename "$f")
        echo "  ðŸ“ $name"
      done
      ;;
    robot)
      find "$OBS_VAULT/robots" -name "*.md" -type f | sort -r | head -10 | while read f; do
        local name=$(basename "$f")
        echo "  ðŸ¤– $name"
      done
      ;;
    weeknote)
      find "$WEB_CONTENT/week-notes" -name "*.md" -type f 2>/dev/null | sort -r | head -10 | while read f; do
        local name=$(basename "$f")
        echo "  ðŸ“… $name"
      done
      ;;
    *)
      error "Unknown type: $type"
      echo "Available: blog, robot, weeknote, reading, projects, drafts"
      exit 1
      ;;
  esac
}

cmd_info() {
  local file="$1"
  [ -z "$file" ] && { error "file required"; exit 1; }

  # Try to find the file
  local full_path
  if [ -f "$OBS_VAULT/$file" ]; then
    full_path="$OBS_VAULT/$file"
  elif [ -f "$OBS_VAULT/$file.md" ]; then
    full_path="$OBS_VAULT/$file.md"
  else
    error "File not found: $file"
    exit 1
  fi

  log "File: $(basename "$full_path")"
  echo "  Path: $full_path"
  echo "  Size: $(du -h "$full_path" | cut -f1)"
  echo "  Modified: $(stat -f%Sm -t%Y-%m-%d\ %H:%M "$full_path")"
  echo ""

  # Show frontmatter
  head -20 "$full_path" | grep -E "^(---|\w+:)" | head -10
}

cmd_open() {
  local file="$1"
  [ -z "$file" ] && { error "file required"; exit 1; }
  ~/.dotfiles/bin/obs open "$file"
}

# --- Main Dispatcher ---
[ $# -eq 0 ] && { usage; exit 0; }

# Parse global flags
while [[ $# -gt 0 ]]; do
  case "$1" in
    -d|--dry-run) DRY_RUN=1; shift ;;
    -f|--force) FORCE=1; shift ;;
    -q|--quiet) QUIET=1; shift ;;
    -h|--help) usage; exit 0 ;;
    *) break ;;
  esac
done

cmd="$1"
shift

case "$cmd" in
  status)       cmd_status ;;
  import)       cmd_import ;;
  watch)        cmd_watch ;;
  publish)      cmd_publish ;;
  preview)      cmd_preview "$@" ;;
  info)         cmd_info "$@" ;;
  open|o)       cmd_open "$@" ;;
  help|h)       usage ;;
  *)
    error "Unknown command: $cmd"
    usage
    exit 1
    ;;
esac
