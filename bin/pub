#!/bin/bash
# pub - Publishing workflow bridge (Obsidian â†’ website2)
# Simplifies the content creation + publishing pipeline

set -e

OBS_VAULT="/Users/ejfox/Library/Mobile Documents/iCloud~md~obsidian/Documents/ejfox"
WEB_DIR="$HOME/code/website2"
WEB_CONTENT="$WEB_DIR/content"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

usage() {
  cat << EOF
${BLUE}pub${NC} - Publishing workflow (Obsidian â†’ website2)

${YELLOW}USAGE${NC}
  pub <command> [options]

${YELLOW}COMMANDS${NC}
  status                    Show publishing status
  import                    Run import pipeline (Obsidian â†’ website2)
  watch                     Watch vault for changes and auto-import
  publish                   Full publish workflow (import â†’ build â†’ push)
  preview <type>            Preview posts of type (blog, robot, weeknote, etc)
  info <file>               Show metadata for a file
  open <file>               Open file in Obsidian

${YELLOW}OPTIONS${NC}
  -d, --dry-run            Show what would happen (import only)
  -f, --force              Skip safety checks
  -q, --quiet              Minimal output

${YELLOW}EXAMPLES${NC}
  pub import               Import all whitelisted content
  pub publish              Full publish workflow
  pub watch                Auto-import on vault changes
  pub preview blog         See recent blog posts
  pub status               Check what's pending

EOF
}

log() {
  if [ "$QUIET" != "1" ]; then
    echo -e "${BLUE}[pub]${NC} $*"
  fi
}

success() {
  echo -e "${GREEN}âœ“${NC} $*"
}

error() {
  echo -e "${RED}âœ—${NC} $*" >&2
}

warn() {
  echo -e "${YELLOW}âš ${NC} $*"
}

cmd_status() {
  echo ""
  echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${BLUE}â•‘${NC}            Publishing Status Dashboard                         ${BLUE}â•‘${NC}"
  echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""

  # --- Obsidian Vault Stats ---
  echo -e "${YELLOW}ðŸ“š Obsidian Vault Stats${NC}"
  local vault_size=$(du -sh "$OBS_VAULT" 2>/dev/null | cut -f1)
  local total_files=$(find "$OBS_VAULT" -type f -name "*.md" | wc -l)
  local total_words=$(find "$OBS_VAULT" -type f -name "*.md" -exec wc -w {} + 2>/dev/null | tail -1 | awk '{print $1}')

  echo "  Size: $vault_size"
  echo "  Total files: $total_files"
  # Format with commas (handle empty gracefully)
  if [ ! -z "$total_words" ] && [ "$total_words" != "0" ]; then
    echo "  Total words: $(echo $total_words | sed ':a;s/\B[0-9]\{3\}\>/,&/g;ta')"
  fi

  # Vault breakdown by type
  local blog_files=$(find "$OBS_VAULT/blog" -name "*.md" 2>/dev/null | wc -l)
  local robots_files=$(find "$OBS_VAULT/robots" -name "*.md" 2>/dev/null | wc -l)
  local weeknotes_files=$(find "$OBS_VAULT/week-notes" -name "*.md" 2>/dev/null | wc -l)
  local drafts_files=$(find "$OBS_VAULT/drafts" -name "*.md" 2>/dev/null | wc -l)

  echo "  â”œâ”€ blog: $blog_files"
  echo "  â”œâ”€ robots: $robots_files"
  echo "  â”œâ”€ week-notes: $weeknotes_files"
  echo "  â””â”€ drafts: $drafts_files"
  echo ""

  # --- Website2 Git Status ---
  echo -e "${YELLOW}ðŸ”§ Website2 Git Status${NC}"
  cd "$WEB_DIR"

  local branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
  local changes=$(git status --porcelain | wc -l)
  local commits_ahead=$(git rev-list @{u}..HEAD 2>/dev/null | wc -l || echo "0")
  local last_commit=$(git log -1 --format='%h - %s (%ar)' 2>/dev/null)

  echo "  Branch: $branch"
  echo "  Last commit: $last_commit"

  if [ "$commits_ahead" -gt 0 ]; then
    warn "  Commits ahead of origin: $commits_ahead"
  else
    success "  In sync with origin"
  fi

  if [ "$changes" -gt 0 ]; then
    warn "  Uncommitted changes: $changes files"
    echo "  Changed files:"
    git status --short | head -8 | sed 's/^/    /'
  else
    success "  Working tree clean"
  fi
  echo ""

  # --- Website2 Content Stats ---
  echo -e "${YELLOW}ðŸ“„ Website2 Content${NC}"
  local blog_count=$(find "$WEB_CONTENT/blog" -name "*.md" 2>/dev/null | wc -l)
  local weeknote_count=$(find "$WEB_CONTENT/week-notes" -name "*.md" 2>/dev/null | wc -l)
  local robot_count=$(find "$WEB_CONTENT" -name "*robot*" -type d 2>/dev/null | wc -l)
  local content_size=$(du -sh "$WEB_CONTENT" 2>/dev/null | cut -f1)

  echo "  Published content: $content_size"
  echo "  â”œâ”€ blog posts: $blog_count"
  echo "  â”œâ”€ week notes: $weeknote_count"
  echo "  â””â”€ robots: $robot_count"

  # Recent updates
  echo ""
  echo "  Recent updates:"
  find "$WEB_CONTENT" -name "*.md" -type f -newer "$OBS_VAULT/.obsidian" 2>/dev/null | \
    sort -r | head -3 | while read f; do
      local name=$(basename "$f" .md)
      local mtime=$(stat -f%Sm -t%m-%d\ %H:%M "$f" 2>/dev/null)
      echo "    â†³ [$mtime] $name"
    done
  echo ""

  # --- Site Health Check ---
  echo -e "${YELLOW}ðŸŒ Site Status${NC}"
  local site_url="https://ejfox.com"
  local http_code=$(curl -s -o /dev/null -w "%{http_code}" "$site_url" 2>/dev/null)
  local response_time=$(curl -s -o /dev/null -w "%{time_total}s" "$site_url" 2>/dev/null)

  if [ "$http_code" = "200" ]; then
    success "  Website is live ($http_code OK)"
    echo "  Response time: ${response_time}"
  elif [ "$http_code" = "000" ]; then
    error "  Cannot reach $site_url (network error)"
  else
    warn "  Website returned HTTP $http_code"
  fi

  # Check specific endpoints
  local api_code=$(curl -s -o /dev/null -w "%{http_code}" "$site_url/api/stats.get" 2>/dev/null)
  if [ "$api_code" = "200" ]; then
    success "  API is responding"
  else
    warn "  API returned HTTP $api_code"
  fi
  echo ""

  # --- Deployment Info ---
  echo -e "${YELLOW}ðŸš€ Deployment Info${NC}"
  if [ -f "$WEB_DIR/.env.local" ]; then
    success "  .env.local configured"
  fi

  local node_modules_size=$(du -sh "$WEB_DIR/node_modules" 2>/dev/null | cut -f1)
  echo "  node_modules: $node_modules_size"

  local build_dir_size=$(du -sh "$WEB_DIR/.output" 2>/dev/null | cut -f1)
  if [ ! -z "$build_dir_size" ]; then
    echo "  .output (build): $build_dir_size"
  fi

  # Check package.json scripts
  if grep -q '"publish"' "$WEB_DIR/package.json" 2>/dev/null; then
    success "  publish script available"
  fi
  echo ""

  # --- Recent Activity ---
  echo -e "${YELLOW}ðŸ“Š Recent Activity${NC}"
  echo "  Last 3 vault changes:"
  find "$OBS_VAULT" -type f -name "*.md" ! -path "*/.obsidian/*" -newer "$OBS_VAULT/.obsidian/workspace.json" 2>/dev/null | \
    head -3 | while read f; do
      local name=$(basename "$f")
      local mtime=$(stat -f%Sm -t%H:%M "$f" 2>/dev/null)
      echo "    â†³ [$mtime] $name"
    done
  echo ""

  # --- Quick Commands ---
  echo -e "${YELLOW}âš¡ Quick Commands${NC}"
  echo "  pub import        â†’ Run import pipeline"
  echo "  pub watch         â†’ Auto-import on vault changes"
  echo "  pub publish       â†’ Full publish workflow"
  echo "  obs search <term> â†’ Find notes in vault"
  echo ""
}

cmd_import() {
  log "Running import pipeline..."

  cd "$WEB_DIR"

  if [ "$DRY_RUN" = "1" ]; then
    log "(dry run mode - no files will be modified)"
    node scripts/blog/import.mjs --dry-run 2>&1 | head -20
  else
    if ! node scripts/blog/import.mjs; then
      error "Import failed"
      exit 1
    fi
    success "Import completed"
    cmd_status
  fi
}

cmd_watch() {
  log "Starting file watcher..."
  log "Watching: $OBS_VAULT"
  warn "Press Ctrl+C to stop"

  cd "$WEB_DIR"
  bash scripts/blog/watch.sh
}

cmd_publish() {
  if [ "$FORCE" != "1" ]; then
    log "Running full publish workflow"
    log "This will:"
    echo "  1. Import content from Obsidian"
    echo "  2. Build the site"
    echo "  3. Commit and push changes"
    echo ""
    read -p "Continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      log "Cancelled"
      exit 0
    fi
  fi

  cd "$WEB_DIR"

  log "Starting publish workflow..."
  if bash scripts/blog/publish.sh; then
    success "Publish completed successfully"
  else
    error "Publish failed - check logs"
    exit 1
  fi
}

cmd_preview() {
  local type="${1:-blog}"
  log "Preview: $type posts"

  case "$type" in
    blog)
      find "$WEB_CONTENT/blog" -name "*.md" -type f | sort -r | head -10 | while read f; do
        local name=$(basename "$f")
        echo "  ðŸ“ $name"
      done
      ;;
    robot)
      find "$OBS_VAULT/robots" -name "*.md" -type f | sort -r | head -10 | while read f; do
        local name=$(basename "$f")
        echo "  ðŸ¤– $name"
      done
      ;;
    weeknote)
      find "$WEB_CONTENT/week-notes" -name "*.md" -type f 2>/dev/null | sort -r | head -10 | while read f; do
        local name=$(basename "$f")
        echo "  ðŸ“… $name"
      done
      ;;
    *)
      error "Unknown type: $type"
      echo "Available: blog, robot, weeknote, reading, projects, drafts"
      exit 1
      ;;
  esac
}

cmd_info() {
  local file="$1"
  [ -z "$file" ] && { error "file required"; exit 1; }

  # Try to find the file
  local full_path
  if [ -f "$OBS_VAULT/$file" ]; then
    full_path="$OBS_VAULT/$file"
  elif [ -f "$OBS_VAULT/$file.md" ]; then
    full_path="$OBS_VAULT/$file.md"
  else
    error "File not found: $file"
    exit 1
  fi

  log "File: $(basename "$full_path")"
  echo "  Path: $full_path"
  echo "  Size: $(du -h "$full_path" | cut -f1)"
  echo "  Modified: $(stat -f%Sm -t%Y-%m-%d\ %H:%M "$full_path")"
  echo ""

  # Show frontmatter
  head -20 "$full_path" | grep -E "^(---|\w+:)" | head -10
}

cmd_open() {
  local file="$1"
  [ -z "$file" ] && { error "file required"; exit 1; }
  ~/.dotfiles/bin/obs open "$file"
}

# --- Main Dispatcher ---
[ $# -eq 0 ] && { usage; exit 0; }

# Parse global flags
while [[ $# -gt 0 ]]; do
  case "$1" in
    -d|--dry-run) DRY_RUN=1; shift ;;
    -f|--force) FORCE=1; shift ;;
    -q|--quiet) QUIET=1; shift ;;
    -h|--help) usage; exit 0 ;;
    *) break ;;
  esac
done

cmd="$1"
shift

case "$cmd" in
  status)       cmd_status ;;
  import)       cmd_import ;;
  watch)        cmd_watch ;;
  publish)      cmd_publish ;;
  preview)      cmd_preview "$@" ;;
  info)         cmd_info "$@" ;;
  open|o)       cmd_open "$@" ;;
  help|h)       usage ;;
  *)
    error "Unknown command: $cmd"
    usage
    exit 1
    ;;
esac
