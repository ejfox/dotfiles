#!/bin/bash
# AI-powered commit message generator using Claude Code CLI
# Enhanced with: fzf selection, recent commits context, branch name context

set -e

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get staged diff
DIFF=$(git diff --cached)

if [ -z "$DIFF" ]; then
    echo -e "${RED}Error: No staged changes${NC}" >&2
    exit 1
fi

# Get additional context
BRANCH=$(git branch --show-current 2>/dev/null || echo "unknown")
RECENT_COMMITS=$(git log --oneline --no-decorate -5 2>/dev/null || echo "No commit history")

# Count staged files for context
STAGED_FILES=$(git diff --cached --name-only | wc -l | xargs)

echo -e "${YELLOW}ðŸ¤– Analyzing ${STAGED_FILES} staged file(s) on branch '${BRANCH}'...${NC}" >&2

# Generate commit messages using Claude
MESSAGES=$(claude --output-format text <<EOF
You are a commit message generator. Analyze the context below and generate exactly 3 conventional commit messages.

BRANCH: ${BRANCH}

RECENT COMMITS (for style/pattern reference):
${RECENT_COMMITS}

STAGED CHANGES:
\`\`\`diff
${DIFF}
\`\`\`

Generate 3 conventional commit messages following this format:
<type>(<scope>): <subject>

Types:
- feat: new feature for the user
- fix: bug fix for the user
- docs: documentation changes
- style: formatting, missing semicolons, etc (no code change)
- refactor: code change that neither fixes a bug nor adds a feature
- perf: code change that improves performance
- test: adding or updating tests
- chore: updating build tasks, package manager configs, etc

Rules:
1. Infer the type from the diff (feat for new files/functions, fix for bug fixes, etc)
2. Infer the scope from the branch name or file paths (e.g., "auth", "api", "ui")
3. Subject should be lowercase, imperative mood, no period at end
4. Be concise (max 72 chars total) but descriptive
5. Match the style of recent commits if possible
6. Output ONLY the 3 commit messages, one per line, no numbering or formatting

Think about WHAT changed and WHY (not HOW). Consider the business value.
EOF
)

# Check if Claude CLI succeeded
if [ $? -ne 0 ] || [ -z "$MESSAGES" ]; then
    echo -e "${RED}Error: Failed to generate commit messages${NC}" >&2
    exit 1
fi

# Save diff to temp file for fzf preview
DIFF_FILE=$(mktemp)
echo "$DIFF" > "$DIFF_FILE"

# Use fzf to select commit message with diff preview
SELECTED=$(echo "$MESSAGES" | fzf \
    --height=50% \
    --reverse \
    --border \
    --prompt="Select commit message > " \
    --preview="echo 'ðŸ“ COMMIT MESSAGE:\n'; echo {}; echo '\nðŸ“Š STAGED DIFF:\n'; cat $DIFF_FILE" \
    --preview-window=right:60%:wrap \
    --header="ðŸ¤– AI-Generated Commit Messages (Ctrl-C to cancel)" \
    --color="fg:#f5d0dc,bg:#0d0d0d,hl:#ff0055,fg+:#ffffff,bg+:#2d1a22,hl+:#ff3344,info:#ff0077,prompt:#ff0055,pointer:#ff0055,marker:#ff0055,spinner:#ff0077,header:#ff6688")

# Clean up temp file
rm -f "$DIFF_FILE"

# Check if user cancelled
if [ -z "$SELECTED" ]; then
    echo -e "${YELLOW}Cancelled${NC}" >&2
    exit 1
fi

# Output the selected message (lazygit will use this)
echo "$SELECTED"
