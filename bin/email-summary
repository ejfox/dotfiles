#!/bin/bash
# Smart email summary for startup script with AI insights

# Cache for 10 minutes
EMAIL_CACHE="/tmp/startup_cache/email_summary_cache.txt"
EMAIL_CACHE_MIN=10

# Check cache first
if [[ -f "$EMAIL_CACHE" ]] && [[ -z $(find "$EMAIL_CACHE" -mmin +$EMAIL_CACHE_MIN 2>/dev/null) ]]; then
  cat "$EMAIL_CACHE"
  exit 0
fi

# Check if maildir exists and has been synced
if [ ! -d "$HOME/Maildir/Inbox" ]; then
    echo "  ðŸ“§ Email not synced yet" | tee "$EMAIL_CACHE"
    exit 0
fi

# Count unread emails in inbox
unread_count=$(find "$HOME/Maildir/Inbox/new" -type f 2>/dev/null | wc -l | tr -d ' ')

if [ "$unread_count" -eq 0 ]; then
    echo "  âœ“ Inbox zero"
    exit 0
fi

# Get recent emails for AI summary
find "$HOME/Maildir/Inbox/new" -type f 2>/dev/null | head -10 | while read email; do
    subject=$(grep -i "^Subject:" "$email" 2>/dev/null | sed 's/Subject: //')
    from=$(grep -i "^From:" "$email" 2>/dev/null | sed 's/From: //' | sed 's/<.*>//' | tr -d '"')
    echo "From: $from | Subject: $subject"
done > /tmp/email_raw.txt

if [ -s /tmp/email_raw.txt ] && command -v llm >/dev/null 2>&1; then
    # NUCLEAR FILTER: Only surface genuinely urgent items
    # Ignore: newsletters, receipts, marketing, notifications, automated alerts
    result=$(cat /tmp/email_raw.txt | llm -m 4o-mini --no-log -s "You are a BRUTAL email filter. Only output emails that are:
- From actual humans who need a response
- Bills/payments actually due soon (not receipts)
- Meeting requests or calendar invites
- Urgent work requests

IGNORE and do not mention: newsletters, marketing, receipts, order confirmations, automated notifications, subscription notices, GitHub/deploy alerts, promotional emails.

If NOTHING passes the filter, output exactly: NONE

Otherwise output max 2 items, format: [!] description (10 words max)
No [>] or [-] - if it's not urgent, don't show it." 2>/dev/null | tr -cd '\11\12\15\40-\176')

    # Only cache/display if there's something real
    if [ -n "$result" ] && [ "$result" != "NONE" ]; then
        echo "$result" | sed 's/^/  /' | tee "$EMAIL_CACHE"
    else
        rm -f "$EMAIL_CACHE"  # Clear cache so section doesn't show
    fi
else
    echo "  ðŸ“§ $unread_count unread messages" | tee "$EMAIL_CACHE"
fi

rm -f /tmp/email_raw.txt